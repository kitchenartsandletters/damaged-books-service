{%- comment -%} NEW/SAFE DAMAGED DETECTION {%- endcomment -%}
{%- assign is_damaged_page = false -%}
{%- if product.handle contains '-damaged-' or product.handle contains '-damage-' -%}
{%- assign is_damaged_page = true -%}
{%- endif -%}

{%- unless is_damaged_page -%}
{%- assign conditions = "light,moderate,heavy" | split: "," -%}
{%- assign damaged_links = "" -%}

{%- for condition in conditions -%}
    {%- assign damaged_handle = product.handle | append: '-damaged-' | append: condition -%}
    {%- assign damaged_product = all_products[damaged_handle] -%}
    {%- if damaged_product and damaged_product != blank and damaged_product.available -%}
    {%- assign link_html = '<p><a href="' | append: damaged_product.url | append: '" class="damaged-book-link">View Damaged Copy (' | append: condition | append: ')</a></p>' -%}
    {%- assign damaged_links = damaged_links | append: link_html -%}
    {%- endif -%}
{%- endfor -%}

{%- if damaged_links != blank -%}
    <div class="damaged-book-section">
    <p>We received some copies of this book which are less than perfect. While supplies last, we are offering these copies at a reduced price. These copies are first come, first served; we cannot reserve one. We also can’t predict if or when more will arrive.</p>
    <p>When you order one of these, we’ll choose the best remaining copy in the condition you select. Damaged book purchases are final sale—no returns or exchanges.</p>
    {{ damaged_links }}
    </div>
{%- endif -%}
{%- endunless -%}

{%- comment -%} DAMAGED PAGE CALLOUT {%- endcomment -%}
{%- if product.handle contains '-damaged-' or product.handle contains '-damage-' -%}
{%- if product.handle contains '-damaged-' -%}
    {%- assign parts = product.handle | split: '-damaged-' -%}
{%- else -%}
    {%- assign parts = product.handle | split: '-damage-' -%}
{%- endif -%}
{%- assign base_handle = parts[0] -%}
{%- assign condition = parts[1] -%}
{%- assign main_product = all_products[base_handle] -%}

{%- case condition -%}
    {%- when 'light' -%}
    {%- assign condition_copy = "<strong>Lightly damaged</strong> means minor bumps or corner wear that don’t affect readability." -%}
    {%- when 'moderate' -%} {# NOTE: 'moderate', not 'mod' #}
    {%- assign condition_copy = "<strong>Moderately damaged</strong> means more noticeable exterior wear or a few wrinkled/torn pages." -%}
    {%- when 'heavy' -%}
    {%- assign condition_copy = "<strong>Heavily damaged</strong> often includes spine issues; handle with care to preserve usability." -%}
{%- endcase -%}

<div class="damaged-condition-callout">
    {%- if condition_copy -%}<p>{{ condition_copy }}</p>{%- endif -%}
    {%- if main_product and main_product != blank -%}
    <p><a href="{{ main_product.url }}">Prefer a new copy?</a></p>
    {%- endif -%}
</div>
{%- endif -%}